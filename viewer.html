<!DOCTYPE html>
<!--
Fooocus Log Viewer
Github repository 
https://github.com/toutjavascript/Fooocus-Log-Viewer

https://github.com/lllyasviel/Fooocus/discussions/693#discussioncomment-7853694

         Created by https://github.com/sngazm
Modestly updated by https://github.com/toutjavascript
                    https://www.toutjavascript.com

File Version 2024-02-19/A1
-->

<html lang="us">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Viewer:Fooocus Log Viewer</title>

    <script src="https://cdn.tailwindcss.com"></script>


    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
 
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css" rel="stylesheet" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsdiff/5.1.0/diff.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>

    <link href="https://cdn.jsdelivr.net/gh/StephanWagner/jBox@v1.3.3/dist/jBox.all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/gh/StephanWagner/jBox@v1.3.3/dist/jBox.all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@honatas/multi-select-webcomponent/dist/multi-select-webcomponent.min.js" crossorigin="anonymous"></script>
  </head>

  <body class="text-white">
    <div id="app"></div>
    <script type="text/babel">

      var LOGVIEWER_RELEASE="1.5.5" 

      $("span#logviewer-release").html("Release "+LOGVIEWER_RELEASE)

      window.customElements.define('multi-select', MultiselectWebcomponent);

      var configs=[
        {item: "autoReloadToday", type: "checkbox", label: "Auto Reload (only on today page)", value: false},
        {item: "workingDates", type: "text", label: "Working Dates", value: ""},
        {item: "playSound", type: "checkbox", label: "Play Sound when new Image is detected", value: true},
        {item: "soundFile", type: "text", label: "Sound File", value: "https://interactive-examples.mdn.mozilla.net/media/cc0-audio/t-rex-roar.mp3"},
        {item: "viewerDate", type: "text", label: "Start Date", value: ""},
        {item: "displayDiff", type:"checkbox", label:"Display Differences between batches", value: false},
        {item: "displayDetails", type:"checkbox", label:"View Batch Prompt Details", value: true},
        {item: "displayMetaBlock", type:"checkbox", label:"View Meta Detail on Zoomed Image", value: true},
        {item: "nbColumns", type:"integer", label:"Number of columns in the grid", value: 3},
        {item: "nbImagePerPage", type:"integer", label:"Number of images displayed per page", value: 32},
      ];

      var nbDaysToScan=250; /* Number of days to scan for working dates befor today */

      var workingDates=[], detailDates=[];
      var allBatches=[], allModels=[], allStyles=[], allImages=[]; 
      var nbImageNotFoundByBatches=[]; /* Number of images not found by batch (deleted by user) : use to display on each batch block */

      var searchResults=[];           /* Array of images found by searchBox */
      var nbImageNotFoundBySearch=0;  /* Number of images not found on search via searchBox */
      var modeSearch=false;           /* Flag that indicates if searchBox is active */
      var promiseAll=false;           /* Flag that indicates if all images are loaded: calendar and search button could be active */
      var searchPaginationPage=0;     /* Actual Pagination page for search results */
      var searchPaginationNbImage=60; /* Number of images per page for search results */


      function getParam(item) {
        return localStorage.getItem(item);
      }
      function saveParam(item, value) {
        localStorage.setItem(item, value);
      }

      /* Load configurations and localStorage on App init */
      function loadConfig() {
        setTimeout(checkNewImage, 1000);
      }

      function goPlaySound() {
        if (localStorage.getItem("playSound")=="true") {
          var audio =new Audio("https://interactive-examples.mdn.mozilla.net/media/cc0-audio/t-rex-roar.mp3");
          audio.play();
        } 
      }

      /* Detection of new Image on today folder */
      var nbTodayImages=0;
      function checkNewImage() {
        let today=new Date(); today=today.toISOString().substr(0,10);
        fetch(`./${today}/log.html`, { cache: "no-store" })
        .then(function(response) {
          return response.text();
        })
        .then((text) => {
          let matches=text.match(/<div id=\"([a-z0-9_\-])+\"/g);
          let nb=((matches|| []).length);
          if ((nb>nbTodayImages)&&(nbTodayImages>0)) {
            let n=nbTodayImages-nb;
            matches.sort();
            let src=matches[matches.length-1].replace('<div id="',"").replace("_png",".png").replace("_jpg",".jpg").replace("_jpeg",".jpeg").replace("_webp",".webp").replace('"',"");
            new jBox('Notice', {
              content: "Yeah! "+n+" new Image"+(n>1?'s':'')+" generated now on today folder<br><img src='./"+today+"/"+src+"' class='imageNotice'>",
              theme: "TooltipNewImage"
            });
            goPlaySound();
          }
          nbTodayImages=nb;
          /* Update calendar */
          /* Check if today is in workingDates */
          if (nbTodayImages>0) {
            if (workingDates.includes(today)) {
              detailDates[today]=nb;          
            } else {
              /* Add today at 0 index to workingDates*/
              workingDates.unshift(today);
              detailDates[today]=nb;
            }
            toggleCalendar(); toggleCalendar();  /* Update div#calendarList*/

            /* Reprocess of today log.html */
            var newData=parseLog(text);
            /* Remove all images where image.dt=today from allImages */
            for (let i=0; i<allImages.length; i++) {
              if (allImages[i].dt==today) {
                allImages.splice(i,1);
                i--;
              }
            }

            /* Re-add today images to allImages */
            for (let i=newData.data.length-1; i>=0; i--) {
              let img=newData.data[i];
              img.dt=today;
              if (allModels.includes(img["Base Model"])==false) {
                allModels.push(img["Base Model"]);
              }

              img.styles=[];
              if (img.Styles!="[]") {
                let reg=new RegExp("(')", "g");
                if (img.Styles) img.styles=img.Styles.replace("[","").replace(reg,"").replace("]","").split(", ");
              }
      
              for (let j=0; j<img.styles.length; j++) {
                if (allStyles.includes(img.styles[j])==false) {
                  allStyles.push(img.styles[j]);
                }
              }

              allImages.unshift(img);
            }

            /* if mode Search active, refresh search box display */
            if (modeSearch) {
              goSearch(false);
            }
          }

          setTimeout(checkNewImage, 5000);
        });    
      }
      
      /* Create an empty image 
         Update batch label error
      */
      function getNotFoundImg(batchNumber) {
        if (typeof nbImageNotFoundByBatches[batchNumber]=="undefined") {
          nbImageNotFoundByBatches[batchNumber]=0;
        }
        nbImageNotFoundByBatches[batchNumber]++;

        $("span#batchNumber-"+batchNumber).html(" / "+nbImageNotFoundByBatches[batchNumber]+" not found").attr("title", "Probably deleted by user");

        /* Generate image not found */
        let svgElement = document.createElementNS("http://www.w3.org/2000/svg", 'svg'); // Create a new SVG element
        svgElement.setAttribute('width', '500');    // Set the width and height of the SVG canvas
        svgElement.setAttribute('height', '500');
        
        let rect = document.createElementNS("http://www.w3.org/2000/svg", 'rect');  // Create a new <rect> element to represent border
        rect.setAttribute('x', 2);     // Position the rectangle at (50,50) on the SVG canvas
        rect.setAttribute('y', 2);
        rect.setAttribute('width', '492');    // Set width and height of the rectangle to cover entire SVG area
        rect.setAttribute('height', '492');
        rect.style.fill = 'none';       // Set fill color of the rectangle to none (transparent)
        rect.style.stroke = '#aaa';     // Set stroke color of the rectangle
        rect.style.strokeWidth = '4';    // Set width of the border
        svgElement.appendChild(rect);  // Append the <rect> element to the SVG canvas
        
        let text = document.createElementNS("http://www.w3.org/2000/svg", 'text');  // Create a new <text> element for "Not Found"
        text.setAttribute('x', 60);     // Position the text at (50,50) on the SVG canvas
        text.setAttribute('y', 250);
        text.style.fontSize = '48';     // Set the font size of the text
        text.style.fill = '#aaa';      // Set the color of the text
        text.innerHTML = "Image Not Found";    // Set the content of the <text> element to "Not Found"
        svgElement.appendChild(text);  // Append the <text> element to the SVG canvas


        // Serialize the SVG to a string
        let serializer = new XMLSerializer();
        let svgString = serializer.serializeToString(svgElement);

        // Convert the SVG string to a data URL
        let svgDataUrl = 'data:image/svg+xml,' + encodeURIComponent(svgString);

        return svgDataUrl;              
      }


      function App() {


        const [date, setDate] = React.useState(() => {
          const date = localStorage.getItem("viewerDate")
            ? new Date(localStorage.getItem("viewerDate"))
            : new Date();
          return date;
        });

        const [data, setData] = React.useState([]);
        const [isLoading, setIsLoading] = React.useState(false);
        const [isCorsError, setIsCorsError] = React.useState(false);
        const [isNotFoundError, setIsNotFoundError] = React.useState(false);
        const [playSound, setPlaySound] = React.useState(false);
        const [autoReload, setAutoReload] = React.useState(() => {
          const autoReload = localStorage.getItem("autoReload")
            ? localStorage.getItem("autoReload") == "true"
            : false;
          return autoReload;
        });
        React.useEffect(() => {
          localStorage.setItem("autoReload", autoReload.toString());
        }, [autoReload]);

        const isToday = date.toDateString() === new Date().toDateString();
        const dateStr = getDateStr(date);

        const handleUpdateDate = (dateStr) => {
          const [year, month, day] = dateStr
            .split("-")
            .map((str) => parseInt(str));
          setDate(new Date(year, month - 1, day));
        };



        /* Use the workingDates array to navigate directly to a date with images */
        const getWorkingDate = (dt, way) => {
          let dtComp=dt.toISOString().substr(0,10);
          console.log("getWorkingDate("+dt+","+way+")")
          if (workingDates.length>0) {
            if (way>0) {
              for (let i=workingDates.length-1; i>=0; i--) {
                console.log(i+" workingDates[i]="+workingDates[i])
                if (workingDates[i]>=dtComp) {
                  console.log("ok")
                  return new Date(workingDates[i])
                }
              }
            } else {
              for (let i=0; i<workingDates.length; i++) {
                if (workingDates[i]<=dtComp) {return new Date(workingDates[i])}
              }
            }
          }
          return dt;
        }

        const goTomorrow = () => {
          const tomorrow = new Date(date);
          tomorrow.setDate(tomorrow.getDate() + 1);          
          setDate(getWorkingDate(tomorrow, 1));
        };
        const goYesterday = () => {
          const yesterday = new Date(date);
          yesterday.setDate(yesterday.getDate() - 1);
          setDate(getWorkingDate(yesterday, -1));
        };
        const goDate0 = (e) => {
          console.log("goDate("+e.target.value+")");
          const day = new Date(e.target.value);
          console.log("day="+day);
          day.setDate(day.getDate());
          console.log("day="+day);
          setDate(day);
        }
        const goDate = (e) => {
          console.log("goDate("+e.target.value+")");
          // Changed the direct entry into Date with a split version of the date string broken by year, month, day
          let wd_sp = e.target.value.split("-"); // split date into its parts
          const day = new Date(parseInt(wd_sp[0]), parseInt(wd_sp[1])-1, parseInt(wd_sp[2])); // loading parts directly in Date object
          console.log("day="+day);
          day.setDate(day.getDate());
          console.log("day="+day);
          setDate(day);
        }

        const fetchData = () => {
          if (!isToday) {
            setAutoReload(false);
          }
          localStorage.setItem("viewerDate", date.toDateString());
          setIsLoading(true);
          fetch(`./${dateStr}/log.html`, { cache: "no-store" })
          .then((response) => {
            if (!response.ok) {
                console.log(`Nothing to load on ${dateStr}`);
            }
            return response.text()
          })
          .then((text) => parseLog(text))
          .then((data) => {
            const newData = data.data;
            console.log("newData: ", newData);
            setData(newData);
            setIsNotFoundError(false);
            setIsCorsError(false);
            setIsLoading(false);
          })
          .catch((e) => {
              // CORS error
              // console.error(e);
              //console.log(e)
              //console.log(`Nothing to load on ${dateStr}`);
              if (e.name === "TypeError") {
                setIsCorsError(true);
              }
              if (e.name === "SyntaxError") {
                setIsNotFoundError(true);
              }
              setData(null);
              setIsLoading(false);
            });
            
        };
        React.useEffect(fetchData, [date]);

        React.useEffect(() => {

          if (autoReload) {
            const interval = setInterval(() => {
              fetchData();
            }, 15000);
            return () => clearInterval(interval);
          }
        }, [autoReload]);


        return (
          <div className="pb-2">
            <div className="px-1 py-0">

                <button id="config" onClick={() => viewConfig() }
                  className={ (window.location.href.indexOf("#debug")>0) ? "px-2 mx-2 text-xl " : "px-2 mx-2 text-xl hidden" }
                  type="text"
                  >
                  &#x2699;
                </button>


              <span class="smartphoneHidden">Fooocus Log Viewer</span>
              <button className="px-2 mx-2 text-xl" onClick={() => goYesterday()}>
                ◀️
              </button>
              <input id="inputDay"
                className="text-gray-900"
                type="date"
                value={dateStr}
                onChange={(e) => {
                  handleUpdateDate(e.target.value);
                }}
              />
              <button className="px-2 mx-2 text-xl" onClick={() => {
                  goTomorrow();
                }}
              >
                ▶️
              </button>

              <input id="changeCalendar"
                className="hidden"
                type="text"
                onClick={(e) => {
                  console.log(e);
                  goDate(e);
                }}              
              />

                <button id="config" onClick={() => viewSearchBox() }
                  className="px-2 mx-2 text-xl "
                  type="text"
                  >
                  &#x1f50d;
                </button>



              <div id="calendar" class="px-2 text-2xl cursor-pointer" title="Show list of all working days">	&#128197; </div>

              <label>
                Sound on new Image: 
                <input
                class="ml-1 mr-3"
                type="checkbox"
                checked={playSound}
                onChange={() => {
                  console.log("onchange playSound");
                  setPlaySound(!playSound);
                  saveParam("playSound", !playSound);
                }}
                />


              </label>


              {isToday ? (
                <>
                  <label>
                    {isLoading ? (
                      <span className="text-gray-500">Loading...</span>
                    ) : (
                      "AutoReload:"
                    )}
                    <input
                    class="ml-1 mr-3"
                    type="checkbox"
                    checked={autoReload}
                    onChange={() => {
                      if (!autoReload) {
                        fetchData();
                      }
                      setAutoReload(!autoReload);
                      saveParam("autoReloadToday", !autoReload);
                    }}
                  />
                  </label>
                </>
              ) : (
                isLoading && <span className="text-gray-500">Loading...</span>
              )}
            </div>

            <div id="searchBox" class="px-2 pt-2 pb-1"></div>

            <div id="calendarList" class="px-2 pt-2 pb-1"></div>

            {!isLoading && (
              <>
                {isCorsError && (
                  <p className="text-center m-16">
                    Put this viewer.html file in Fooocus/outputs directory 
                    <br /> 
                    <br /> 
                    
                    Please access viewer.html from your Fooocus local server.{" "}<br /> 
                
                    In most cases, the URL is{" "}<br />
                    <button class="p-2 shadow-sm bg-purple-500 rounded-md"><a href="http://localhost:7860/file=outputs/viewer.html">
                      http://localhost:7860/file=outputs/viewer.html
                    </a></button>{" "}
                    <br /><br />
                    or
                    <br /><br />
                    <a class="p-2 shadow-sm bg-purple-500 rounded-md" href="http://localhost:7865/file=outputs/viewer.html">
                      http://localhost:7865/file=outputs/viewer.html
                    </a>
                    <br /><br /><br /><br />
                  </p>
                  
                )}
                {isNotFoundError && (
                  <p className="text-center m-16">
                    {dateStr}/all.json Not found.
                  </p>
                )}
              </>
            )}

            {data && data.length > 0 ? (
              <ImageViewer dateStr={dateStr} data={data} />
            ) : (
              <div>
                <p className="text-center m-16">No data in this folder</p>
                <p className="text-center m-2">Looking for last folder with images. </p>
                <p className="text-center m-2"><a class="p-2 shadow-sm bg-purple-500 rounded-md hidden cursor-pointer" id="nearestDate">Click to see the earliest generation date</a></p>
              </div>
            )}
          </div>
        );
      }


      /* Configuration block */

      function saveConfig() {
        /* Save the config in localStorage */

      }
      
      function deleteConfig() {
        // Clears the entire local storage
        localStorage.clear();
      }


      /* Activate the search mode */
      function viewSearchBox() {
        console.log("Start viewSearchBox()");
        deleteMouseOverThumbnail();

        if (!promiseAll) {
          new jBox('Notice', {
            content: "All logs and images are not processed. Please wait...",
            theme: 'TooltipDark',
            attributes: {x: "right", y: "bottom"},
            offset: { x: 20, y: 45 }
          }); 
          return;
        }

        if (modeSearch) {
          modeSearch=false;
          $("div#searchBox").hide();
          $("div#reactBox").show();
          return;
        } else {
          modeSearch=true;
          $("div#searchBox").show();
          $("div#reactBox").hide();
          $("div#calendarList").hide();
        }



        /* First opening */
        if ($("div#searchBox").html()=="") {
          let m="";
          for (let i=0; i<allModels.length; i++) {
            m+="<option value='"+allModels[i].replace(".safetensor","")+"'>"+allModels[i].replace(".safetensor","")+"</option>";
          }
          let s="";
          for (let i=0; i<allStyles.length; i++) {
            s+="<option value='"+allStyles[i]+"'>"+allStyles[i]+"</option>";
          }

          let html=`

          <form name="formSearch" id='formSearch' class="p-1 rounded" onsubmit='return false' method="post">
            <div class='text-center' ><strong>SearchBox Active : ${allImages.length} images in ${workingDates.length} outputs folders</strong></div>

            <label>
              Text in prompts (AND):         
              <input type='text' name='searchText' id='searchText' class='p-2' placeholder='Type text to search'>
            </label>

            <label>
              Models (AND):
              <multi-select name='searchModel' id='searchModel' class='p-1'
              
              selecteditem="badge cursor-pointer bg-primary pt-1 m-1"
              dropdown="border"
              dropdownitem="p-1"
              selectallbutton="btn btn-sm btn-light"
              selectallbuttonspan="bi-check2-all text-success"
              clearbutton="btn btn-sm btn-light"
              clearbuttonspan="bi-x-circle text-danger">
                ${m}
              </multi-select>
            </label>

            <label>
              Styles (OR):
              <multi-select name='searchStyle' id='searchStyle' class='p-1'
              selecteditem="badge bg-primary pt-1 m-1"
              dropdown="border"
              dropdownitem="p-1"
              selectallbutton="btn btn-sm btn-light"
              selectallbuttonspan="bi-check2-all text-success"
              clearbutton="btn btn-sm btn-light"
              clearbuttonspan="bi-x-circle text-danger">
                ${s}
              </multi-select>
            </label>
            <button class='text-lg bg-lime-500 hover:bg-lime-700 px-2 py-1.5 leading-5 rounded-md font-semibold text-white' onclick='return goSearch()'>Search</button>

            <button class='text-lg bg-slate-500 hover:bg-slate-700 px-2 py-1.5 leading-5 rounded-md font-semibold text-white' onclick='viewSearchBox()'>Quit Search Mode</button>
          </form>
          <div id="resultBox" class="px-0 mt-1 "></div>

          `;
          $("div#searchBox").html(html);
        }
      }

      /* Display all images with pagination */
      function displaySearchResult() {
        deleteMouseOverThumbnail();
        nbImageNotFoundBySearch=0;
        console.log("searchPaginationPage="+searchPaginationPage);


        if (searchResults.length==0) {
          $("div#resultBox").html("<div class='text-lg text-center m-5 p-5'>&#x2205; No images found with this search options</div>");        
        } else {
          let html="<div class='text-lg text-center'>Search results: "+searchResults.length+" images found  <span id='nbImageNotFoundBySearch' class='batchError'></span></div>";

          let pagination="";

          if (searchResults.length>searchPaginationNbImage) {
            let buttonPrevious="<button class='button-pagination text-lg bg-sky-500 hover:bg-sky-700 px-2 py-1.5 leading-5 rounded-md font-semibold text-white' onclick='searchPaginationPage--; displaySearchResult()'>Previous</button>";
            if (searchPaginationPage==0) {
              buttonPrevious="<button class='button-pagination text-lg bg-slate-500  px-2 py-1.5 leading-5 rounded-md font-semibold text-white' >Previous</button>";
            }

            let buttonNext="<button class='button-pagination text-lg bg-sky-500 hover:bg-sky-700 px-2 py-1.5 leading-5 rounded-md font-semibold text-white' onclick='searchPaginationPage++; displaySearchResult()'>Next</button>";
            if (searchPaginationPage==Math.ceil(searchResults.length/searchPaginationNbImage)-1) {
              buttonNext="<button class='button-pagination text-lg bg-slate-500  px-2 py-1.5 leading-5 rounded-md font-semibold text-white' >Next</button>";
            }

            let combo=`<select class="px-2" id="combo-pagination" onchange="searchPaginationPage=parseInt(this.options[this.selectedIndex].value); displaySearchResult()">`;
            for (let i=0; i<Math.ceil(searchResults.length/searchPaginationNbImage); i++) {
              combo+=`<option value="${i}" ${i==searchPaginationPage?"selected":""}>${i+1}</option>`;
            }
            combo+="</select>";

            pagination=`<div class="flex flex-row justify-center text-base">
              ${buttonPrevious}
              <span class="pagination">Page </span> ${combo} <span class="pagination"> of ${Math.ceil(searchResults.length/searchPaginationNbImage)}</span>
              ${buttonNext}
            </div>`;
          }


          html+=pagination;

          html+=`<div id="containerFilesX">
            <div id="filesX" class="grid gap-1 p-1 grid-cols-${getParam("nbColumns")} imgViewer">`;

          for (let i=(searchPaginationPage)*searchPaginationNbImage; i<Math.min(searchResults.length, (searchPaginationPage+1)*searchPaginationNbImage); i++) {
            let data=searchResults[i];
            let json=JSON.stringify(data).replace(/"/g, "&quot;");
            html+=`
            <div class="col p-1 imgViewer">
              <img src="/file=outputs/${data.dt}/${data.src}" 
              loading="lazy" 
              alt="${data.src}" 
              class="responsive thumbnail cursor-zoom-in" 
              alt={data.src}
              data-seed="${data.Seed}"
              data-name="${data.src}"
              data-json="${json}"
              data-error="false"
              onerror="errorImageSearch(this)"
              onload="loadImageSearch(this, ${i}, ${searchResults.length})"
              onmouseover="mouseOverThumbnailSearch(this)"
              />
              <div class="fileName">${data.src}</div>
            </div>`; 
          }
          html+=`</div>
          </div>`;

          html+=pagination;

          $("div#resultBox").html(html);

        }      
      }


      /* Search text in all prompts */
      function goSearch(newSearch=true) {
        deleteMouseOverThumbnail();
        if (newSearch) { /* If refresh when new image detected, newSearch=false */
          nbImageNotFoundBySearch=0;
          searchPaginationPage=0;
        }

        let txt=document.forms["formSearch"].searchText.value.trim();
        let models=document.querySelector("#searchModel").value;
        let styles=document.querySelector("#searchStyle").value;
        searchResults=[];


        if ((txt=="")&&(models.length==0)&&(styles.length==0)) {
          $("div#resultBox").html("<div class='text-lg text-center m-5 p-5'>&#x2205; No search options selected</div>");
          return false;
        }

        var reg=new RegExp("[ ,;]+", "g");

        for (let i=0; i<allImages.length; i++) {
          let found=false;
          let img=allImages[i];
          if (txt!="") {
            var mots=txt.split(reg);
            for (let j=0; j<mots.length; j++) {
              if (img.Prompt.toLowerCase().indexOf(mots[j].toLowerCase().trim())>=0) {
                found=true;
              } else {
                found=false;
                break;
              }
            }
          } else {
            /* Check text: if empty, image is always found */
            found=true;
          }

          
          /* Check Models (or) */
          if ((models.length>0)&&(found)) {
            found=false;
            if (models.includes(img["Base Model"].replace(".safetensor",""))) {
              found=true;
            }
          }

          /* Check Styles (and) */
          if ((styles.length>0)&&(found)) {
            for (let j=0; j<styles.length; j++) {
              if (!img.Styles.includes(styles[j])) {
                /* If only one style is not in the image, it's not found */
                found=false;
              }
            }
          }

          if (found) {
            searchResults.push(img);
          }
        }
        displaySearchResult();

        return false;
      }

      function mouseOverThumbnailSearch(img) {
        if (img.dataset.error=="false") {
          deleteMouseOverThumbnail();
          
          $('<div id="divIMGMeta">').css({
            top: $(img).offset().top+'px',
            left: $(img).offset().left+'px',
          }).html('Metadatas: click to copy all')
          .attr("title", "Click to copy MetaDatas to clipboard")
          .on("click", function(evt) {
            evt.stopPropagation();
            $("div#divIMGMeta").addClass("flash");
            copyMetadatatoClipboard(img.dataset.json);
          })
          .appendTo('body');

          let format=reduce(img.dataset.width, img.dataset.height);
          $('<div id="divIMGSize">').css({
            top: ($(img).offset().top+$(img).height()-24)+'px',
            left: $(img).offset().left+'px'   
          })
          .html(img.dataset.width+"×"+img.dataset.height+" ("+format.join("/")+")"+" - "+(img.dataset.size>0?format_filesize(img.dataset.size):""))
          .appendTo('body');
          
          $('<div id="divIMGDownload">').css({
            top: ($(img).offset().top+$(img).height()-42)+'px',
            left: ($(img).offset().left+$(img).width()-34)+'px'   
          }).html('<button id="download" title="Click to download" class="text-2xl" style="display: inline-block; position: absolute; top: 10px; left: 1px; text-align: center;">⬇</button>')
          .on("click", (evt) => {
            evt.stopPropagation();
            downloadImage(img.src, img.dataset.name)
            .then(() => { console.log('The image has been downloaded');  })
            .catch(err => {console.log('Error downloading image: ', err);});
          })
          .appendTo('body');
        }
      }



      function loadImageSearch(image, index, max) {
        image.setAttribute("data-index", index);
        image.setAttribute("id", "img-load-detection-"+index);
        /* Get images info width, height and filesize */
        get_filesize(image.src, function(size) {
          image.setAttribute("data-size", size);
        });
        let i=new Image();
        i.src=image.src;
        i.addEventListener("load", function() {
          image.setAttribute("data-width", i.width)
          image.setAttribute("data-height", i.height)
          if ((typeof image.dataset.onclick == "undefined")&&(image.dataset.error=="false")) {
            /* Add only one eventClickListener, necessary because multiple calls*/
            /* Add only if image is not broken */
            $(image).addClass("cursor-zoom-in").addClass("img-load-detection");
            image.setAttribute("data-onclick", "1");
            image.addEventListener("click", function(evt) {
              zoomImage(evt.target);
            })

            $(image).on("mouseover", function(evt) {
              
            });
     
    
          }  
        });

        
      }


      function errorImageSearch(img) {
        nbImageNotFoundBySearch++;
        $("span#nbImageNotFoundBySearch").html("(but "+nbImageNotFoundBySearch+" images deleted by user)");
        $(img).parent().hide();
        
      }



      function viewConfig() {
        if ($("#configDiv").length>0) {
          $("#configDiv").remove();
          return;
        }
        let html="<div class='text-lg text-center'>Fooocus Log Viewer Configuration</div>";
        for (let i=0; i<configs.length; i++) {
          let config=configs[i];
          if (config.type=="checkbox") {
            html+="<div class='flex flex-row justify-between text-base'><label class='text-sm'>"+config.label+"</label>";
            html+="<input type='checkbox' id='"+config.item+"' class='configItem' "+(localStorage.getItem(config.item)=="true" ? "checked" : "")+">";
            html+="</div>";
          }
          if (config.type=="integer") {
            html+="<div class='flex flex-row justify-between text-base'><label class='text-sm'>"+config.label+"</label>";
            html+="<span type='text' id='"+config.item+"' class='' value=''>"+localStorage.getItem(config.item)+"</span>";
            html+="</div>";
          }

        }
        html+="<div class='flex flex-row justify-between'><button class='text-lg bg-red-500 hover:bg-red-700 px-2 py-1.5 leading-5 rounded-md font-semibold text-white m-1 bg-red-500 leading-5 rounded-md font-semibold text-white' onclick='viewConfig()'>Cancel</button> <button class='text-lg m-1 bg-sky-500 hover:bg-sky-700 px-2 py-1.5 leading-5 rounded-md font-semibold text-white' onclick=''>Save Config</button> </div> <button class='text-lg m-1 bg-sky-500 hover:bg-sky-700 px-2 py-1.5 leading-5 rounded-md font-semibold text-white' onclick='deleteConfig()'>Delete Config</button> </div>";

        var conf=$('<div id="configDiv">').css({
          position: 'absolute',
          top: '50px',
          left: '20px',
          color: '#ffffff',
          backgroundColor: '#000000',
          border:"3px solid #999",
          boxShadow:"5px 5px 5px #333",
          padding: '10px',
          borderRadius: '10px',
          fontSize: '12px',
          opacity:1,
          color:'#fff',
          width: '320px' 
        })
        .addClass("")
        .html(html).appendTo(document.body);
      
      }


      function ImageViewer({ data, dateStr }) {
        const [mode, setMode] = React.useState("images"); // images, batches

        const [currentPage, setCurrentPage] = React.useState(1);
        const itemsPerPageSelects = [8, 16, 32, 64, 128];
        /* Get Item per pages from localStorage if exists */
        let perPage=32;
        if (getParam("nbImagePerPage")) {
          perPage=parseInt(getParam("nbImagePerPage"));
        } else {
          itemsPerPageSelects[2];
          saveParam("nbImagePerPage", perPage);
        }

        const [itemsPerPage, setItemsPerPage] = React.useState( perPage );
        const [asc, setAsc] = React.useState(false);
        const [showDiff, setShowDiff] = React.useState(false);
        const [showDetail, setShowDetail] = React.useState(false);

        // Init numCols from body width or from localStorage
        let numCols=2;
        if ($("body").width()>800) numCols=3;
        if ($("body").width()>1200) numCols=5;
        if (getParam("nbColumns")) {
          numCols=parseInt(getParam("nbColumns"));
        } else {
          saveParam("nbColumns", numCols);
        }
        
        const [numColumns, setNumColumns] = React.useState(numCols);

        // Sort the data based on the title (generated timestamp)
        const sortedData = [...data].sort((a, b) => {
          if (asc) {
            return a.src.localeCompare(b.src);
          } else {
            return b.src.localeCompare(a.src);
          }
        });
        const batchData = getBatchData(sortedData);

        React.useEffect(() => {
          nbImageNotFoundByBatches=[];         

          setShowDetail(getParam("displayDetails")=="true"?true:false);
          setShowDiff(getParam("displayDiff")=="true"?true:false);
          if (currentPage > Math.ceil(data.length / itemsPerPage)) {
            setCurrentPage(Math.ceil(data.length / itemsPerPage));
          }
          imgLoadDetection();
        }, [itemsPerPage, dateStr, mode, sortedData]);


        // Calculate the range of data for the current page
        let startIndex, endIndex, numPages, firstImageInPage, lastImageInPage;
        if (mode === "images") {
          startIndex = (currentPage - 1) * itemsPerPage;
          endIndex = startIndex + itemsPerPage;
          numPages = Math.ceil(data.length / itemsPerPage);
          firstImageInPage = (currentPage - 1) * itemsPerPage + 1;
          lastImageInPage = Math.min(currentPage * itemsPerPage, data.length);
        }
        if (mode === "batches") {
          startIndex = batchData[currentPage - 1].startIndex;
          endIndex = batchData[currentPage - 1].endIndex + 1;
          numPages = batchData.length;
          firstImageInPage = startIndex + 1;
          lastImageInPage = endIndex;
        }

        const currentBatches = getCurrentBatchData(
          sortedData,
          batchData,
          startIndex,
          endIndex
        );

        const pageInfo = {
          mode,
          currentPage,
          setCurrentPage,
          numPages,
          numImages: data.length,
          firstImageInPage,
          lastImageInPage,
        };


        const pageData = [];
        pageData.push(sortedData.slice(startIndex, endIndex));
        return (
          <div id="reactBox">
            <div className="px-4 py-1 flex flex-row flex-wrap justify-between">
              <div className="sm:basis-1/2 basis-full">
                <div className="">
                  Mode:{" "}
                  {mode === "images" ? (
                    <span className="font-bold cursor-pointer">Images</span>
                  ) : (
                    <span className="cursor-pointer" onClick={() => setMode("images")}>Images</span>
                  )}{" "}
                  |{" "}
                  {mode === "batches" ? (
                    <span className="font-bold cursor-pointer">Batches</span>
                  ) : (
                    <span className="cursor-pointer" onClick={() => setMode("batches")}>Batches</span>
                  )}
                </div>
                <div className="">
                  {mode === "images" && (
                    <>
                      Images/page:{" "}
                      {itemsPerPageSelects.map((value) => (
                        <label key={value} class="labelImgPerPage">
                          <input
                            id="itemsPerPage"
                            type="radio"
                            value={value}
                            checked={itemsPerPage === value}
                            onChange={() => {setItemsPerPage(value); saveParam("nbImagePerPage", value);}}
                          />{" "}
                          {value}
                        </label>
                      ))}
                      <br />
                    </>
                  )}
                  <label>
                    Order:{" "}
                    <button
                      onClick={() => {
                        setAsc(!asc);
                      }}
                    >
                      {asc ? "⬆️" : "⬇️"}
                    </button>
                  </label>
                  
                  <label>
                    &nbsp;&nbsp;
                    Diff:{" "}
                    <input
                      id="showDiff"
                      type="checkbox"
                      checked={showDiff }
                      onChange={() => {saveParam("displayDiff", !showDiff); setShowDiff(!showDiff); }}
                    />
                  </label>

                  <label>                    
                    &nbsp;&nbsp;
                    Batch Details:{" "}
                    <input
                      id="showDetail"
                      type="checkbox"
                      checked={showDetail}
                      onChange={() => {saveParam("displayDetails", !showDetail); setShowDetail(!showDetail); }}
                    />
                  </label>

                </div>
              </div>
              <div className="sm:basis-1/2 basis-full pt-2">
                <PageController {...pageInfo} />
              </div>
            </div>

            <div>
              {currentBatches.map((item, index) => (
                <BatchGallery
                  key={item.timeStr}
                  batch={item}
                  showDiff={showDiff}
                  showDetail={showDetail}
                  numColumns={numColumns}
                />
              ))}
              <GalleryController
                numColumns={numColumns}
                setNumColumns={setNumColumns}
              />
            </div>

            <PageController {...pageInfo} scrollToTop />
          </div>
        );
      }

      function BatchGallery({ batch, showDiff, showDetail, numColumns }) {
        const numBatchImages = batch.endIndex - batch.startIndex + 1;
        const dateStr = getDateStr(new Date());
        return (
          <div className="py-2 ">
            <div className="border m-2 p-2">
              <p className="flex justify-between">
                <span className="text-base mb-0">
                  <strong>Batch {batch.batchNumber}</strong> ({numBatchImages}{" "}
                  Images<span id={"batchNumber-"+batch.batchNumber} class="batchError"></span>)
                </span>
                <span>{batch.timeStr}</span>
              </p>
              <div class={showDetail ? ( "hidden" ) : ( "" ) }>
                <strong>{batch.batchSettings["Base Model"].replace(".safetensors", "")}</strong>
                {batch.batchSettings["Refiner Model"]!="None" ? (
                  <>
                    &nbsp;/&nbsp;<strong>{batch.batchSettings["Refiner Model"].replace(".safetensors", "")}</strong>
                    &nbsp;x {batch.batchSettings["Refiner Switch"]}
                  </>
                ) : ( <span></span> ) 
              }
              &nbsp;/&nbsp;<strong>{batch.batchSettings["Performance"]}</strong>

              </div>
              <div class={showDetail ? ( "" ) : ( "hidden" ) }>
                {Object.entries(batch.batchSettings).map(([key, value], idx) => (
                  <div key={idx} class="text-sm ">
                    <strong>{key}:</strong>{" "}
                    {batch.batchSettingDiffs[key] &&
                    batch.batchSettingDiffs[key].length > 0 &&
                    showDiff ? (
                      <span>{batch.batchSettingDiffs[key].map((v) => v)}</span>
                    ) : (
                      <span>
                        {key == "LoRAs" ? (
                          <> 
                            <br />
                            <span>
                              {value.map((LoRA, idx) => (
                                <span key={idx}>
                                  {LoRA.name}: {LoRA.weight}
                                  {idx < value.length - 1 ? <br /> : ""}
                                </span>
                              ))}
                            </span>
                          </>
                        ) : Array.isArray(value) ? (
                          <> </>
                        ) : (
                          <>
                          {key == "Styles" ? (
                            <div class="flex">
                            {value.replace(/'/g, "").replace("[","").replace("]","").split(", ").map((style, i) => (
                              style.trim() !== "" && (
                              <div class="flex-initial text-center mx-1 styleContainer">
                              <img src={ ("/file=sdxl_styles/samples/"+style.toLowerCase().replace(/ /g,"_")+".jpg") } class="styleImage"/>
                              <span class="styleTitle">{style}</span>
                              </div>
                              )
                            ))}
                            </div>
                          ) :
                          (
                            value
                          )}
                          </>
                        )}
                      </span>
                    )}
                  </div>
                ))}
                </div>
            </div>
            <div>
              <div className={`grid gap-1 p-1 grid-cols-${numColumns}`}>
                {batch.currentPageData.map((data, idx) => {
                  const dateStr = data.src.split("_")[0];
                  return (
                    <div key={idx} className="">
                      <img
                        className="img-load-detection max-w-screen max-h-screen object-contain"
                        src={`./${dateStr}/${data.src}`}
                        alt={data.src}
                        data-seed={data.Seed}
                        data-name={data.src}
                        data-json={JSON.stringify(data)}
                        data-error="false"
                        data-batch={batch.batchNumber}
                        onError={ (evt => {
                          evt.target.dataset.error="true";
                          evt.target.src=getNotFoundImg(evt.target.dataset.batch);
                          $(evt.target).parent().hide();
                        }) }
                        width="100%"
                      />
                      <p className="text-gray-500 text-sm hideOverflowSrc">{data.src}</p>
                    </div>
                  );
                })}
              </div>
            </div>
          </div>
        );
      }

      function PageController({
        mode,
        currentPage,
        setCurrentPage,
        numPages,
        numImages,
        firstImageInPage,
        lastImageInPage,
        scrollToTop,
      }) {
        return (
          <div className="flex justify-center">
            <button
              className="bg-transparent hover:bg-blue-500 text-white font-semibold hover:text-white py-2 px-4 border border-white hover:border-transparent rounded disabled:bg-gray-500 disabled:border-gray-800 disabled:text-white"
              onClick={() => setCurrentPage((prev) => Math.max(prev - 1, 1))}
              disabled={currentPage === 1}
            >
              ◀️
            </button>
            <span className="p-2">
              {mode === "batches" ? "Batch" : "P."} {currentPage} / {numPages} (
              {firstImageInPage} - {lastImageInPage} / {numImages} Images)
            </span>
            <button
              className="bg-transparent hover:bg-blue-500 text-white font-semibold hover:text-white py-2 px-4 border border-white hover:border-transparent rounded disabled:bg-gray-500 disabled:border-gray-800 disabled:text-white"
              onClick={() => {
                setCurrentPage((prev) => Math.min(prev + 1));
                if (scrollToTop) {
                  window.scroll({
                    top: 0,
                    left: 0,
                    behavior: "smooth",
                  });
                }
              }}
              disabled={currentPage === numPages}
            >
              ▶️
            </button>
          </div>
        );
      }

      function GalleryController({ numColumns, setNumColumns }) {
        return (
          <div className="sticky bottom-0 p-2">
            <button
              className="bg-transparent hover:bg-blue-500 text-white font-semibold hover:text-white py-2 px-4 border border-white hover:border-transparent rounded disabled:bg-gray-500 disabled:border-gray-800 disabled:text-white"
              onClick={() => {setNumColumns((prev) => Math.max(prev - 1, 1)); saveParam("nbColumns", Math.max(numColumns - 1, 1));}}
              disabled={numColumns === 1}
            >
              口
            </button>
            <button
              className="bg-transparent hover:bg-blue-500 text-white font-semibold hover:text-white py-2 px-4 border border-white hover:border-transparent rounded disabled:bg-gray-500 disabled:border-gray-800 disabled:text-white"
              onClick={() => {setNumColumns((prev) => prev + 1); saveParam("nbColumns", numColumns+1);}}
            >
              田
            </button>
          </div>
        );
      }

      const getDateStr = (date) => {
        console.log(date)
        return date
          .toLocaleDateString("ja-JP", {
            year: "numeric",
            month: "2-digit",
            day: "2-digit",
          })
          .replaceAll("/", "-");
      };

      const parseLog = (html) => {

        const data = [];
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, "text/html");
        const images = doc.querySelectorAll("div[id$='_png'],div[id$='_jpg'],div[id$='_jpeg'],div[id$='_webp']"); 
        for (let i = 0; i < images.length; i++) {
          const paragraphs = images[i].querySelectorAll("p");
          const divs = images[i].querySelectorAll("div");
          const trs = images[i].querySelectorAll("tr");
          const settings = {};
          let src;

          if (paragraphs.length==0) {
            /* From v2.1.852 (2023-12-18), log changed to <table> tag */ 
            src = divs[0].innerText;
            settings.crudLoras=[];
            for (let j = 1; j < trs.length; j++) { 
              const row = trs[j];
              const labelTd = row.querySelector("td.label");
              const key = labelTd? labelTd.textContent : row.querySelector("td.key").textContent;
              const value = row.querySelector("td.value").textContent;
              if (key.substr(0,4)=="LoRA") {
                settings["crudLoras"].push(value);
              } else {
                settings[key] = value;
              }
            }
          } else {
            src = paragraphs[0].textContent; if (src=="") { src = paragraphs[1].textContent; }
            for (let j = 1; j < paragraphs.length; j++) {
              const text = paragraphs[j].textContent;
              const nodes = paragraphs[j].childNodes;
              for (let n = 0; n < nodes.length; n++) {
                const node = nodes[n];
                if (node.nodeName === "B") {
                  const key = node.previousSibling.textContent
                    .replace(": ", "")
                    .replace(", ", "");
                  const value = node.textContent;
                  settings[key] = value;
                }
              }
            }
          }
          if (settings["Prompt"]) {
            data.push({
              src,
              ...settings,
            });
          }
        }
        // console.log(data);

        return {
          data,
        };
      };

      const getBatchData = (data) => {
        const batchData = [];
        const isAsc = data.length < 2 || data[0].src < data[1].src;
        console.log("getBatchData: data=")
        console.log(data)
        for (let i = 0; i < data.length; i++) {
          if (i === 0 || !isSameBatch(data[i], data[i - 1])) {
            batchData.push({
              batchSettings: {
                "Base Model": data[i]["Base Model"],
                "Refiner Model": data[i]["Refiner Model"],
                "Refiner Switch": data[i]["Refiner Switch"] ?? "",
                Prompt: data[i]["Prompt"],
                "Negative Prompt": data[i]["Negative Prompt"],
                Styles: data[i]["Styles"],
                "Performance": data[i]["Performance"],
                "Use Fooocus V2 (Prompt Expansion)": data[i][
                  "Fooocus V2 Expansion"
                ]
                  ? "true"
                  : "false",
                LoRAs: [],
              },
              batchSettingDiffs: {
                "Base Model": [],
                "Refiner Model": [],
                "Refiner Switch": [],
                "Use Fooocus V2 (Prompt Expansion)": [],
                Prompt: "",
                "Performance": [],
                "Negative Prompt": [],
                LoRAs: [],
                Styles: []
              },
              timeStr: data[i].src.split("_")[1].replaceAll("-", ":"),
              currentPageData: [],
              startIndex: i,
              endIndex: i,
            });
            // filter out the property starting with "LoRA"
            //console.log("data["+i+"]");             console.log(data[i])
            Object.keys(data[i]).forEach((key) => {
              /* console.log("i="+i+"  key:" +key) */
              if (key.startsWith("crudLoras")) { /* After V2.1.854 log format */
                try {
                  for (let j=0; j<data[i][key].length; j++) {
                    const lora=data[i][key][j].split(":");
                    console.log("LORA new "+lora[0]+" / "+lora[1]);
                    batchData[batchData.length - 1].batchSettings.LoRAs.push({
                      name: lora[0].trim(),
                      weight: lora[1].trim()
                    });
                  }
                } catch(e) {
                  console.log("error get lora "+e)
                }
              }
            });
          } else {
            if (batchData.length > 0) {
              batchData[batchData.length - 1].endIndex = i;
            }
          }
        }

        for (let i = 0; i < batchData.length; i++) {
          if (isAsc) {
            batchData[i].batchNumber = i + 1;
          } else {
            batchData[i].batchNumber = batchData.length - i;
          }
        }
        // console.log({isAsc, batchData})

        // get the diff of the prompt from the previous batch
        for (let i = 0; i < batchData.length; i++) {
          
          // skip if the current batch is the oldest batch
          if (isAsc && i === 0 || !isAsc && i === batchData.length - 1) {
            continue
          }

          // skip if the current batch doesn't have the "Base Model" setting
          // (Generated by upscaling or others)
          if (!batchData[i].batchSettings["Base Model"]) {
            continue
          }

          // find the second latest batch which has the "Base Model" setting
          const oldBatches = isAsc ? batchData.slice(0, i).reverse() : batchData.slice(i + 1) // newest to oldest
          
          //console.log('i: ', i , batchData[i], {oldBatches})
          const prevBatchIndex = oldBatches
            .findIndex((batch) => {
              return batch.batchSettings["Base Model"]
            });
          
          // skip if you can't find the previous batch
          if (prevBatchIndex < 0) {
            console.log('no previous batch')
            continue
          }

          const prevBatch = oldBatches[prevBatchIndex]
          const currBatch = batchData[i]
          
          console.log("prevBatch");
          
          // finally get the diff of the prompts

          [
            "Base Model",
            "Refiner Model",
            "Refiner Switch",
            "Use Fooocus V2 (Prompt Expansion)",
            "Prompt",
            "Negative Prompt",
          ].forEach((prompt) => {
            const diff = Diff.diffWords(
              prevBatch.batchSettings[prompt],
              currBatch.batchSettings[prompt]
            );
            diff.forEach((part) => {
              if (currBatch.batchSettingDiffs[prompt]) {
                if (part.added) {                
                  currBatch.batchSettingDiffs[prompt].push(
                    <span className="text-green-500">{part.value}</span>
                  );
                } else if (part.removed) {
                  currBatch.batchSettingDiffs[prompt].push(
                    <s className="text-red-500">{part.value}</s>
                  );
                } else {
                  currBatch.batchSettingDiffs[prompt].push(
                    <span>{part.value}</span>
                  );
                }
              }
            });
          });

          // get the diff of the LoRAs from the previous batch
          const prevLoRAs = prevBatch.batchSettings.LoRAs;
          const currLoRAs = currBatch.batchSettings.LoRAs;
          const LoRAsDiff = getLoRAsDiff(prevLoRAs, currLoRAs)
          currBatch.batchSettingDiffs.LoRAs = LoRAsDiff
        }
        // console.log('finished getting batch data', batchData);

        return batchData;
      };

      const getLoRAsDiff = (prevLoRAs, currLoRAs) => {
        const newLoRAs = currLoRAs.filter(
          (currLoRA) =>
            !prevLoRAs.some((prevLoRA) => prevLoRA.name === currLoRA.name)
        );
        const removedLoRAs = prevLoRAs.filter(
          (prevLoRA) =>
            !currLoRAs.some((currLoRA) => currLoRA.name === prevLoRA.name)
        );
        const changedLoRAs = currLoRAs.filter((currLoRA) => {
          const prevLoRA = prevLoRAs.find(
            (prevLoRA) => prevLoRA.name === currLoRA.name
          );
          return prevLoRA && prevLoRA.weight !== currLoRA.weight;
        });
        const result = []
        newLoRAs.forEach((newLoRA) => {
          result.push(
            <>
              <br />
              <span className="text-green-500">
                {newLoRA.name}: {newLoRA.weight}
              </span>
            </>
          );
        });
        changedLoRAs.forEach((changedLoRA) => {
          result.push(
            <>
              <br />
              <span>
                {changedLoRA.name}:{" "}
                <span className="text-green-500">
                  {changedLoRA.weight}
                </span>
              </span>
            </>
          );
        });
        removedLoRAs.forEach((removedLoRA) => {
          result.push(
            <>
              <br />
              <s className="text-red-500">
                {removedLoRA.name}: {removedLoRA.weight}
              </s>
            </>
          );
        });

        return result
      }

      const isSameBatch = (a, b) => {
        // Compare the Prompts and Model names
        const compareKeys = [
          "Prompt",
          "Negative Prompt",
          "Base Model",
          "Refiner Model",
          "Styles",
          "Performance"
        ];
        if (compareKeys.some((key) => a[key] !== b[key])) {
          return false;
        }

        if (
          !!a["Fooocus V2 (Prompt Expansion)"] !==
          !!b["Fooocus V2 (Prompt Expansion)"]
        ) {
          return false;
        }

        // Compare the LoRA names and weights
        const [aLoRAKeys, bLoRAKeys] = [a, b].map((item) =>
          Object.keys(item).filter((key) => key.startsWith("LoRA ["))
        );
        const [aLoRAs, bLoRAs] = [aLoRAKeys, bLoRAKeys].map((keys) =>
          keys.map((key) => {
            const LoRAName = key.split("]")[0].replace("[", "");
            const LoRAWeight = a[key];
            return { LoRAName, LoRAWeight };
          })
        );
        if (aLoRAs.length !== bLoRAs.length) {
          console.log(aLoRAs.length, bLoRAs.length);
          return false;
        }
        if (
          aLoRAs.some(
            (aLoRA, idx) =>
              aLoRA.LoRAName !== bLoRAs[idx].LoRAName ||
              aLoRA.LoRAWeight !== bLoRAs[idx].LoRAWeight
          )
        ) {
          return false;
        }
        return true;
      };

      const getCurrentBatchData = (data, batchData, startIndex, endIndex) => {
        for (let i = startIndex; i < endIndex; i++) {
          const batchIndex = batchData.findIndex(
            (batch) => i >= batch.startIndex && i <= batch.endIndex
          );
          if (batchIndex >= 0) {
            batchData[batchIndex].currentPageData.push(data[i]);
          } else {
            console.log("something wrong");
          }
        }
        const currentBatches = batchData.filter(
          (batch) => batch.currentPageData.length > 0
        );
        return currentBatches;
      };

      ReactDOM.createRoot(document.getElementById("app")).render(<App />);


      /* NEW JS DEVs by toutjavascript */

      /* Display all the days with pictures detected on directory */
      function zoomImage(img, delai=200) {
        let format=reduce(img.dataset.width, img.dataset.height);
        var src = img.src, legende = img.getAttribute("alt"), json=img.dataset.json, modal, index=parseInt(img.dataset.index), max=parseInt(img.dataset.max);
        var legendeSize=img.dataset.width+"×"+img.dataset.height+" ("+format.join("/")+")"+" - "+(img.dataset.size>0?format_filesize(img.dataset.size):"");
        var width='2%';
        var height='2%';
        var top=parseInt($("#img-load-detection-"+index).offset().top-$(window).scrollTop());
        var left=parseInt($("#img-load-detection-"+index).offset().left-$(window).scrollLeft());


        function removeModal() {
          modal.removeClass('scale-up-center').animate({
            width: width,
            height: height,
            top: top,
            left: left, 
            opacity:0
          }, delai, function() {
            modal.remove();
          });
          $('body').off('keyup.modal-close');
        }

        /* Zoom modal window */
        modal = $('<div id=\"modal-photo\">').css({
          background: 'RGBA(0,0,0,.8)',
          width: width,
          height: height,
          position: 'fixed',
          zIndex: '10000',
          top: top,
          left: left,
          opacity: 0
        })
        .attr("data-img-height", img.dataset.height)
        .attr("data-img-width", img.dataset.width)
        .attr("data-img-src", src)
        .appendTo('body').animate({
          width: '100%',
          height: '100%',
          top: 0,
          left:0,
          opacity: 1
        }, delai+20, function() {  
          $("span.copy").attr("title", "Click to copy to clipboard")
          .on("click", function(evt) {
            $(".flash").removeClass("flash")
            navigator.clipboard.writeText($(evt.target).text());
            $(evt.target).addClass("flash");
          });
          updateImageSize();
        })

        /* image block */
        var imageBlock=$('<div>').css({
          position: 'relative',
          background: 'RGBA(0,0,0,.8) url(' + src + ') no-repeat center',
          backgroundSize: 'contain',
          top: '0px',
          left: '0px',
          width: '100%',
          height: '100%',
        }).attr("id", "imageBlock").appendTo(modal);

        /* File name block */
        var info=$('<div>').css({
          display: 'none',
          position: 'absolute',
          top: '10px',
          left: '42px',
          color: '#ffffff',
          fontSize: '17px',
          fontWeight: 'bold',
          textAlign: 'left',
          textShadow: '-2px 0px 2px #000, 0px 2px 2px #000, 2px 0px 2px #000, 0px -2px 2px #000' 
        }).html(legende).appendTo(modal).fadeIn(3*delai);

        var infoSize=$('<div>').css({
          display: 'none',
          position: 'absolute',
          top: '32px',
          left: '42px',
          color: '#ffffff',
          fontSize: '14px',
          fontWeight: 'normal',
          textAlign: 'left',
          textShadow: '-2px 0px 2px #000, 0px 2px 2px #000, 2px 0px 2px #000, 0px -2px 2px #000' 
        }).html(legendeSize).appendTo(modal).fadeIn(3*delai);

        var closeBtn=$('<div>').css({
          display: 'inline-block',
          position: 'absolute',
          top: '10px',
          right: '10px',
          color: '#ffffff',
          fontSize: '25px',
          fontWeight: 'bold',
          textAlign: 'right',
          cursor:'pointer',
          textShadow: '-2px 0px 2px #000, 0px 2px 2px #000, 2px 0px 2px #000, 0px -2px 2px #000' 
        }).html("[Esc]  &#x2715;").on("click", ()=>removeModal()).appendTo(modal).fadeIn(delai);
  
        var next=$('<button id="nextImage">').css({
          display: 'inline-block',
          position: 'absolute',
          top: '50%',
          right: '10px',
          textAlign: 'center',
        }).addClass("text-3xl").html("&#x25b6;").on("click", ()=>changeImage(index, 1, max)).appendTo(modal).fadeIn(delai);

        var prev=$('<button id="previousImage">').css({
          display: 'inline-block',
          position: 'absolute',
          top: '50%',
          left: '10px',
          textAlign: 'center',
        }).addClass("text-3xl").html("&#x25c0;").on("click", ()=>changeImage(index, -1, max)).appendTo(modal).fadeIn(delai);
  

        var download=$('<button id="download">').css({
          display: 'inline-block',
          position: 'absolute',
          top: '10px',
          left: '1px',
          textAlign: 'center',
        }).attr("title", "Click to download")
        .on("click", () => {
          downloadImage(src, img.dataset.name)
          .then(() => { console.log('The image has been downloaded');  })
          .catch(err => {console.log('Error downloading image: ', err);});
        })
        .addClass("text-3xl").html("&#x2b07;").appendTo(modal).fadeIn(delai);
  


        /* Prompts informations */
        var info2=$('<div id="promptInfo">').css({
          position: 'absolute',
          bottom: '0px',
          left: '0px',
          color: '#ffffff',
          fontSize: '12px',
          opacity:1,
          color:'#fff',
          width: '100%' 
        })
        .html(decodeFooocusJSON(json).html).appendTo(modal);
    
        var metadata=$('<div id="divIMGMetaBig">').css({
          position: 'absolute',
          top: '-42px',
          left: '5px',
          color: '#ffffff',
          fontSize: '14px',
          fontWeight: 'normal',
          textAlign: 'left',
          textShadow: '-2px 0px 2px #000, 0px 2px 2px #000, 2px 0px 2px #000, 0px -2px 2px #000' 
        }).html("Metadata: Click to copy all to Clipboard")
        .on("click", function(e) {
          $(e.target).addClass("flash");
          copyMetadatatoClipboard(json);
        })
        .appendTo(info2);

        updateImageSize();


        /* Navigation between zoomed images */
        function changeImage(index, way, max) {
          let newIndex=index+way;
          if (newIndex==0) {
            new jBox('Notice', {
              content: "No image before",
              theme: 'TooltipDark',
              attributes: { x: 'right', y: 'bottom' }
            });  
            return;
          }
          if (newIndex>max) {
            new jBox('Notice', {
              content: "No image after",
              theme: 'TooltipDark',
              attributes: { x: 'right', y: 'bottom' }
            });  
            return;
          }
          removeModal();
          zoomImage(document.querySelector("#img-load-detection-"+newIndex), 0);
        }

        $('body').on('keyup.modal-close', function(e) {
          if (e.key === 'Escape') {
            removeModal();
          }
        });

        $('body').on('keyup.modal-close', function(e) {
          if (e.keyCode === 37) { $("#previousImage").click(); }
          if (e.keyCode === 39) { $("#nextImage").click(); }
        });



        new jBox('Tooltip', {
          attach: '.tooltip',
          theme: 'TooltipDark'
        });
      }


      function toggleCalendar0() {
        if (!promiseAll) {
          new jBox('Notice', {
            content: "All logs and images are not processed. Please wait...",
            theme: 'TooltipDark',
            attributes: {x: "right", y: "bottom"},
            offset: { x: 20, y: 45 }
          }); 
          return;
        }

        if (workingDates.length>0) {
          let list="";
          for (let i=0; i<workingDates.length; i++) {
            let dt=new Date(workingDates[i]);            
          list+="<div class='workingDate' onclick='loadDay("+i+")'>"+dt.toLocaleDateString()+" <span class='nbImages'>"+detailDates[workingDates[i]]+" <span>&#x1f4f7;</span></span></div>"
          }
          $("div#calendarList").html(list).toggle();
        }      

        if (modeSearch) {
          $("div#calendarList").hide();
        }
      }

      function toggleCalendar() {
        if (!promiseAll) {
          new jBox('Notice', {
            content: "All logs and images are not processed. Please wait...",
            theme: 'TooltipDark',
            attributes: {x: "right", y: "bottom"},
            offset: { x: 20, y: 45 }
          });
          return;
        }
      
        if (workingDates.length>0) {
          let list="";
          for (let i=0; i<workingDates.length; i++) {
            let wd_sp = workingDates[i].split("-"); // Same principle, splitting date into its parts
            let dt=new Date(parseInt(wd_sp[0]), parseInt(wd_sp[1])-1, parseInt(wd_sp[2])); // loading parts directly in Date object
          list+="<div class='workingDate' onclick='loadDay("+i+")'>"+dt.toLocaleDateString()+" <span class='nbImages'>"+detailDates[workingDates[i]]+" <span>&#x1f4f7;</span></span></div>"
          }
          $("div#calendarList").html(list).toggle();
        }
      
        if (modeSearch) {
          $("div#calendarList").hide();
        }
      }

      function loadDay(i) {
        $("input#changeCalendar").attr("value", workingDates[i]);
        $("input#changeCalendar").click();
      }


      /* Copies all metadata json to clipboard and displays instructions block */
      function copyMetadatatoClipboard(json) {
        let data=decodeFooocusJSON(json);
        navigator.clipboard.writeText(JSON.stringify(data.copy));
        new jBox('Notice', {
          content: "Metadatas are copied to clipboard.<br> Paste it on prompt textarea to regenerate this image.<br>Then click on 'Load Parameters' button and click on 'Generate' button",
          theme: 'TooltipDark',                
          attributes: { x: 'right', y: 'bottom' }
        });
      }

      function deleteMouseOverThumbnail() {
        /* Thumbnail image */
        $("div#divIMGMeta").remove();
        $("div#divIMGSize").remove();
        $("div#divIMGZoom").remove();
        $("div#divIMGJSON").remove();
        $("div#divIMGDownload").remove();
      }




      function imgLoadDetection() {

        console.log("Start imgLoadDetection()")
        deleteMouseOverThumbnail();





        const images = document.querySelectorAll("img.img-load-detection");
        var index=0;
        images.forEach(function(image) {
          index++;

          image.setAttribute("data-index", index);
          image.setAttribute("id", "img-load-detection-"+index);
          image.setAttribute("data-max", images.length);
          /* Get images info width, height and filesize */
          get_filesize(image.src, function(size) {
            image.setAttribute("data-size", size);
          });
          let i=new Image();
          i.src=image.src;
          i.addEventListener("load", function() {
            image.setAttribute("data-width", i.width)
            image.setAttribute("data-height", i.height)
            if ((typeof image.dataset.onclick == "undefined")&&(image.dataset.error=="false")) {
              /* Add only one eventClickListener, necessary because multiple calls*/
              /* Add only if image is not broken */
              $(image).addClass("cursor-zoom-in");
              image.setAttribute("data-onclick", "1");
              image.addEventListener("click", function(evt) {
                zoomImage(evt.target);
              })
            }  
          });
  
  
  



          image.addEventListener("mouseover", function(evt) {
            let img=evt.target;
            if (img.dataset.error=="false") {
              deleteMouseOverThumbnail();
              
              $('<div id="divIMGMeta">').css({
                top: $(img).offset().top+'px',
                left: $(img).offset().left+'px',
              }).html('Metadatas: click to copy all')
              .attr("title", "Click to copy MetaDatas to clipboard")
              .on("click", function(evt) {
                evt.stopPropagation();
                $("div#divIMGMeta").addClass("flash");
                copyMetadatatoClipboard(img.dataset.json);
              })
              .appendTo('body');
      
              let format=reduce(img.dataset.width, img.dataset.height);
              $('<div id="divIMGSize">').css({
                top: ($(img).offset().top+$(img).height()-24)+'px',
                left: $(img).offset().left+'px'   
              })
              .html(img.dataset.width+"×"+img.dataset.height+" ("+format.join("/")+")"+" - "+(img.dataset.size>0?format_filesize(img.dataset.size):""))
              .appendTo('body');
              
              $('<div id="divIMGDownload">').css({
                top: ($(img).offset().top+$(img).height()-42)+'px',
                left: ($(img).offset().left+$(img).width()-34)+'px'   
              }).html('<button id="download" title="Click to download" class="text-2xl" style="display: inline-block; position: absolute; top: 10px; left: 1px; text-align: center;">⬇</button>')
              .on("click", (evt) => {
                evt.stopPropagation();
                downloadImage(img.src, img.dataset.name)
                .then(() => { console.log('The image has been downloaded');  })
                .catch(err => {console.log('Error downloading image: ', err);});
              })
              .appendTo('body');




            }







          });

        });
      }


      /* Return decoded JSON with all datas usable and an HTML content */
      function decodeFooocusJSON(jsonSource) {
        var json
        try {
          json=JSON.parse(jsonSource);
        } catch(err) {
          console.log("Error parse JSON");
          console.log(jsonSource);
          let data={};
          data.html="ERROR PARSE JSON"
          return data
        }

        let version="?";
        if (typeof json.Version !== "undefined") version=json.Version;

        json.copy={};
        json.copy["Prompt"]=json["Prompt"];
        json.copy["Negative Prompt"]=json["Negative Prompt"];
        json.copy["Fooocus V2 Expansion"]=json["Fooocus V2 Expansion"];
        json.copy["Styles"]=json["Styles"];
        json.copy["Performance"]=json["Performance"];
        json.copy["Resolution"]=json["Resolution"];
        json.copy["Sharpness"]=json["Sharpness"];
        json.copy["Guidance Scale"]=json["Guidance Scale"];
        json.copy["ADM Guidance"]=json["ADM Guidance"];
        json.copy["Base Model"]=json["Base Model"];
        json.copy["Refiner Model"]=json["Refiner Model"];
        json.copy["Refiner Switch"]=json["Refiner Switch"];
        json.copy["Sampler"]=json["Sampler"];
        json.copy["Scheduler"]=json["Scheduler"];
        json.copy["Seed"]=json["Seed"];
        json.copy["Version"]=version;

        json.styles=[];
        if (json.Styles!="[]") {
          let reg=new RegExp("(')", "g");
          json.styles=json.Styles.replace("[","").replace(reg,"").replace("]","").split(", ");
        }

        if (typeof json.crudLoras !== "undefined") {
          /* After v2.1.852, loras are captured differently by DOMparser */
          json.loras=[];
          for (let k in json.crudLoras) {
            let explode=json.crudLoras[k].replace(" : ",":").split(":");
            let weight=explode[1];
            let lora=explode[0];
            json.loras.push({name: lora, weight: weight});
          }
        } else {
          json.loras=[];
          for (let k in json) {
            if (k.substr(0,6)=="LoRA [") {
              let weight=json[k];
              let lora=k.replace("LoRA [","").replace("] weight","");
              json.loras.push({name: lora, weight: weight});
            }
          }
        }

        /* Adds Lora to json.copy */
        for (let i=0; i<json.loras.length; i++) {
          json.copy["LoRA "+(i+1)]=json.loras[i].name+" : "+json.loras[i].weight;
        }

        console.log('getParam("displayMetaBlock")')
        console.log(getParam("displayMetaBlock"))
        json.html=`
          <span class="metadatas" onclick="toggleMetadatas()">Show/Hide Metadatas &#x1F440; </span>
          <div class="containerData flex flex-wrap " style="`+(getParam("displayMetaBlock")!="true" ? "display: none" : "display: flex")+`">
            <div class="blockData sm:basis-2/5 basis-full"> 
              <div class="titreBlockData">Settings</div>
              <div class="itemData"><span class="labelItemData">Prompt</span> <span class="valuePromptData copy">`+json["Prompt"]+`</span></div>`;
              if (json["Negative Prompt"]=="") {
                json.html+=`<div class="itemData"><span class="labelItemData">Negative Prompt</span> <span class="none">none</span></div>`;
              } else {
                json.html+=`<div class="itemData"><span class="labelItemData">Negative Prompt</span> <span class="valuePromptData copy">`+json["Negative Prompt"]+`</span></div>`;
              }


              json.html+=`<div class="itemData"><span class="labelItemData">Seed</span> <span class="valueItemData copy">`+json["Seed"]+`</span></div>
              <div class="itemData">
                <span class="labelItemData">Perf.</span> <span class="valueItemData copy">`+json["Performance"]+`</span> 
                <span class="labelItemData">Resolution</span> <span class="valueItemData copy">`+json["Resolution"]+`</span>
              </div>
            </div>
            <div class="blockData sm:basis-2/5 basis-full"> 
              <div class="titreBlockData">Model & Style</div>
              <div class="itemData"><span class="labelItemData">Base Model</span> <span class="valueItemData copy">`+json["Base Model"]+`</span></div>
              <div class="itemData"><span class="labelItemData">Refiner Model</span> <span class="valueItemData copy">`+json["Refiner Model"]+`</span>
              <span class="labelItemData">Refiner Switch</span> <span class="valueItemData copy">`+json["Refiner Switch"]+`</span></div>

              <div class="itemData"><span class="labelItemData">Styles</span> `;
              for (let i=0; i<json.styles.length; i++) {
                json.html+=`<span class="valueItemData copy">`+json.styles[i]+`</span>`;
              }
              if (json.styles.length==0) {
                json.html+=`<span class="noneData">none</span>` ;
              }
              json.html+=`</div>`;
              if (json.styles.length>0) {
                json.html+=`<div class="itemData"><span class="labelItemData tooltip" title="Prompt auto completed by Fooocus V2 Style choices">Fooocus V2 Expansion Prompt &#9432;</span> <span class="valuePromptData maxHeight copy">`+json["Fooocus V2 Expansion"]+`</span></div>`;
              }


            json.html+=` 

            <div class="itemData"><span class="labelItemData h-7">LoRAs</span> `;
              for (let i=0; i<json.loras.length; i++) {
                json.html+=`<div class="h-7"><span class="valueItemData copy">`+json.loras[i].name.replace(".safetensors","")+"</span> Weight: <b>"+json.loras[i].weight+`</b></div>`;
              }
              json.html+=`</div>


            </div>
            <div class="blockData sm:basis-1/5 basis-full"> 
              <div class="titreBlockData">Advance</div>                 
            
              
              <div class="itemData"><span class="labelItemData">Guid.</span> <span class="valueItemData copy">`+json["Guidance Scale"]+`</span>                     
              <span class="labelItemData">Sharp.</span> <span class="valueItemData copy">`+json["Sharpness"]+`</span></div>
              <div class="titreBlockData">Dev. Debug Mode</div>                 

              <div class="itemData"><span class="labelItemData"> ADM</span> <span class="valueItemData copy">`+json["ADM Guidance"]+`</span></div>
              <div class="itemData"><span class="labelItemData"> Sampler</span> <span class="valueItemData copy">`+json["Sampler"]+`</span></div>
              <div class="itemData"><span class="labelItemData"> Scheduler</span> <span class="valueItemData copy">`+json["Scheduler"]+`</span></div>
            </div>
          </div>
          `;


        return json;
      }


      // Secure text from html inline
      function htmlentities(value){if (value) { return $("<div>").text(value).html() } else { return '' } }

      // Reduce a fraction by finding the Greatest Common Divisor and dividing by it.
      function reduce(numerator, denominator){
        var gcd = function gcd(a,b){
          return b ? gcd(b, a%b) : a;
        };
        gcd = gcd(numerator,denominator);
        return [numerator/gcd, denominator/gcd];
      }
  

      /* Get all outputs directory working dates */
      function calendarGeneration() {
        console.log("Working date calendar generation");
        getAllDates();      
        $("div#calendar").on("click", toggleCalendar);
      }

      /* Fetches on all $dt/log.html */
      function getAllDates() {
        workingDates=[]; detailDates=[];
        function addDay(dt, day) {
          const dt2 = new Date(dt);
          dt2.setDate(dt2.getDate() + day);
          return dt2.toISOString().substr(0,10);
        };
        var dateStr=new Date();  dateStr=dateStr.toISOString().substr(0,10);
        let dates=[];
        for (let i = 0; i < nbDaysToScan; i++) {
          dates.push(addDay(dateStr, -1*i));
        }

        // Maps each dt into a fetch() Promise
        var requests = dates.map(function(dt){
          return fetch(`./${dt}/log.html`, { cache: "no-store" })
          .then(function(response) {
            if (response.ok) {
              workingDates.push(dt);              
            }
            return response.text();
          })
          .then((text) => {
            /* Count nb Images per day in log.html */
            detailDates[dt]=((text.match(/<div id=/g)|| []).length);
            /* Parse log.html to add to allImages array */
            let data=parseLog(text);
            let images=data.data;
            for (let i = 0; i < images.length; i++) {
              let img=images[i];
              img.dt=dt;
              /* Check if the image is generated with a prompt and not with input image */
              if (data.Prompt) {
                allImages.push(img);
                if (allModels.includes(img["Base Model"])==false) {
                  allModels.push(img["Base Model"]);
                }
                img.styles=[];
                if (img.Styles!="[]") {
                  let reg=new RegExp("(')", "g");
                  img.styles=img.Styles.replace("[","").replace(reg,"").replace("]","").split(", ");
                }      
                for (let j=0; j<img.styles.length; j++) {
                  if (allStyles.includes(img.styles[j])==false) {
                    allStyles.push(img.styles[j]);
                  }
                }
              }              
            }

          });
        });

        // Resolve all the promises
        Promise.all(requests)
        .then((results) => {
          promiseAll=true;
          new jBox('Notice', {
            content: "Calendar &#128197; mode and Search 🔍 mode are now active.",
            theme: 'TooltipDark',
            attributes: {x: "right", y: "bottom"},
            offset: { x: 20, y: 45 }
          }); 
          $("a#nearestDate").show().click(function() {loadDay(0)})
          workingDates.sort(); /* Force sort because promise are async */
          workingDates.reverse();
          allModels.sort();
          logSizeInBytes("allImages", allImages);
          logSizeInBytes("allModels", allModels);
          logSizeInBytes("allStyles", allStyles);
          return;
        }).catch(function(err) {
          console.log(err);
        })
      }



      

      /* Button click Show/hide metadatas */
      function toggleMetadatas() {
        $("div.containerData").toggle();
        updateImageSize();
        saveParam("displayMetaBlock", $("div.containerData").css("display")=="none"?false:true);
      }

      /* Update image size container to always fit in visible modal zone */
      function updateImageSize() {
        if ($("div.containerData").css("display")=="none") { 
          $("div#imageBlock").css("height", "100%");
        } else {
          let h=$("#modal-photo").height()-$("div.containerData").height();
          $("div#imageBlock").css("height", h+"px");
        }
      }

      $(window).on("resize", () => updateImageSize());

      function format_filesize(s) { 
        if (s<1024) return s+" Bytes";
        if (s<1024*1024) return (s/1024).toFixed(2)+" KBytes";
        if (s<1024*1024*1024) return (s/1024/1024).toFixed(2)+" MBytes";
        return (s/1024/1024/1024).toFixed(2)+" GBytes"; 
      }

      function get_filesize(url, callback) {
        var xhr = new XMLHttpRequest();
        xhr.open("HEAD", url, true); // Notice "HEAD" instead of "GET", to get only the header
        xhr.onreadystatechange = function() {
          if (this.readyState == this.DONE) {
            callback(parseInt(xhr.getResponseHeader("Content-Length")));
          }
        };
        xhr.send();
      }

      const getSizeInBytes = obj => {
        let str = null;
        if (typeof obj === 'string') {
          // If obj is a string, then use it
          str = obj;
        } else {
          // Else, make obj into a string
          str = JSON.stringify(obj);
        }
        // Get the length of the Uint8Array
        const bytes = new TextEncoder().encode(str).length;
        return bytes;
      };
      
      const logSizeInBytes = (description, obj) => {
        const bytes = getSizeInBytes(obj);
        console.log(`${description} is approximately ${format_filesize(bytes)} `);
      };

      /* Detect if the viewer.html is loaded via iframe on Fooocus UI */
      function isIframe() {
        console.log("window.top.length="+window.top.length);
      }
      isIframe();

      /* Downloading an image via JS */
      async function downloadImage(imageSrc, nameOfDownload = 'image.png' ) {
        const response = await fetch(imageSrc);      
        const blobImage = await response.blob();      
        const href = URL.createObjectURL(blobImage);
      
        const anchorElement = document.createElement('a');
        anchorElement.href = href;
        anchorElement.download = nameOfDownload;
      
        document.body.appendChild(anchorElement);
        anchorElement.click();
      
        document.body.removeChild(anchorElement);
        window.URL.revokeObjectURL(href);
      }
      


      /* On App Init */
      loadConfig();
      setTimeout(calendarGeneration, 500)

    </script>
    <style type="text/css">
      div.flash, span.flash {
        animation: flash 0.5s 1;
      }
      @keyframes flash {
        from {background-color: #fff;}
        to {background-color: #ba00bd;}
      }
      div#divIMGSize {
        position: absolute;
        font-size:11px;
        background-color: #ccc;
        color:#000;
        padding-left: 3px;
        padding-right: 3px;
        border-radius: 3px;
        margin: 2px;
        padding:1px;
        opacity:0.8;
      }
      div#divIMGMeta {
        position: absolute;
        background-color: #000;
        color: #fff;
        padding-left: 3px;
        padding-right: 3px;
        font-size: 13px;
        font-weight: normal;
        font-style: italic;
        margin: 2px;
        border-radius: 3px;
        cursor: pointer;
      }
      div#divIMGMetaBig{
        position: absolute;
        background-color: #000;
        color: #fff;
        padding-left: 3px;
        padding-right: 3px;
        font-size: 15px;
        font-weight: normal;
        font-style: italic;
        margin: 2px;
        border-radius: 3px;
        border:2px solid #ba00bd;
        cursor: pointer;
      }
      div#divIMGZoom {
        position: absolute;
        color: #fff;
        font-size: 30px;
        text-shadow: 2px 2px 2px rgba(0,0,0,0.25);
        font-weight: normal;
        cursor: pointer;
      }
      div#divIMGDownload {
        position: absolute;
        color: #fff;
        font-size: 30px;
        text-shadow: 2px 2px 2px rgba(0,0,0,0.25);
        font-weight: normal;
        cursor: pointer;
      }
      div.containerData {
        font-size:12px;
        background-color: #000;
        color:#fff;
        width:100%;
        border-top: 1px solid #ba00bd;
      }
      div.blockData {
        padding:5px;
      }
      div.titreBlockData {
        font-weight:bold;
        text-align: center;
        margin-top:0px;
        font-size:14px;
        margin-bottom:5px;
        border-bottom:1px dotted #1F2A37;
      }
      div.itemData {
        padding: 5px;
      }      
      span.labelItemData {
        font-weight:bold;
      }
      span.valueItemData {
        border:2px solid #000;
        padding:3px 6px;
        border-radius: 4px;
        margin: 3px 6px 3px 0px;
        background-color: #1F2A37;
      }
      span.valuePromptData {
        display: block;
        border:2px solid #000;
        padding:3px 3px;
        border-radius: 4px;
        margin: 3px 3px;
        background-color: #1F2A37;
        overflow-y: auto;
        max-height:100px;
      }
      .maxHeight {
        max-height:40px !important;
      }

      @media (max-width:481px)  { 
        span.valuePromptData, span.valueItemData {
          margin: 2px;    
        }
        div.itemData {
         padding: 2px;
        }      
        div.titreBlockData {
          margin-bottom:2px;
        }
        div.blockData {
          padding:2px 3px;
        }
        .smartphoneHidden { display:none; }
      }


      span.none {
        color:#fff;
      }
      span.copy {
        cursor: pointer;
      }
      span.copy:hover {
        cursor: pointer;
        border:2px solid #ba00bd;
        background-color: #000;
        color:#fff;
      }   
      
      span.metadatas {
        display:inline-block;
        background-color: #660068bd;
        color:#fff;
        font-size: 18px;
        font-weight: bold;
        padding:6px 10px;
        margin-bottom:0px;
        cursor:pointer;
        text-decoration: underline;
      }
      span.metadatas:hover {
        background-color: #ba00bd;
        color:#fff;
      }

      .jBox-content {
        padding:3px;
        font-size:11px;
        background-color:#fff;
        color:#000
      }

      label.labelImgPerPage {
         padding-right:12px; 
      }


      div#calendar {
        display: inline-block;
        margin-right:10px;
      }
      div#calendarList {
        display: none;
        width:100%;        
      }
      span.nbImages {
        display: inline-block;
        background-color: #ba00bd;
        width:52px;
        border-radius:2px;
        padding:0px 2px;
        color:#fff;
        font-weight: bold;
        text-align: right;
      }
      span.nbImages > span {
        display: inline-block;
      }

      div.workingDate {
        display: inline-block;
        font-size:12px;
        font-weight: bold;
        padding:1px 3px;
        cursor: pointer;
        color: #fff;
        border-radius:5px;
        border:1px solid #ba00bd;
        margin:2px 4px;

      }
      div.workingDate:hover {
        background-color: #ba00bd;
        color: #fff;
      }

      .hideOverflowSrc {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      body {
        background: #0B0F19;
      }

      img.styleImage {
        border-radius: 4px;
      }

      @media (min-width:481px)  { 
        div.styleContainer {
          position: relative;
        }
        span.styleTitle {
          position:absolute;
          top:92px;
          left:0px;
          width:128px;
          height:36px;
          font-size:12px;
          line-height: 12px;
          font-weight: bold;
          background-color: #fff;
          opacity: 0.7;
          color: #000;
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: 4px;

        }
      }

      span.batchError {
        color:#f33;
        font-weight: bold;
      }


      .jBox-TooltipDark  .jBox-content {
        background-color: #ba00bd !important;
        border:1px solid #ba00bd !important;
        color:#fff !important;
        font-weight: bold !important;
        font-size:14px !important;
        box-shadow: 5px 5px 5px #000;
      }

      .jBox-TooltipNewImage  .jBox-content {
        background-color: #000 !important;
        border:1px solid #ba00bd !important;
        color:#fff !important;
        font-weight: bold !important;
        font-size:14px !important;
        box-shadow: 5px 5px 5px #000;
        text-align: center;
      }

      img.imageNotice {
        max-width:320px;
        max-height: 320px;
        
      }

      form#formSearch {     
        border-radius: 5px;
        border:#fde4fd 1px solid;
        background-color: #ba00bd;
      }


      /* Search images */

      div#resultBox {
        background: #000;
        border-radius: 5px;
        border:1px solid #f79cf8
      }

      input, select {
        color:#000;
      }

      input#searchText {
        display: flex;
      }

      multi-select {
        background: #fff;
      }
      div.msw-dropdown {
        background: #fff;
        color:#000;
      }
      div.msw-dropdownitem {
        
        cursor: pointer;
      }
      div.msw-dropdownitem:hover {
        background-color: #ba00bd;
        color:#fff;
      }

      .bg-primary {
        background-color: #ba00bd !important;
      }

      img.responsive {
        width: 100%;
        height: auto;
        max-width: 100%;
      }
      
      div.imgViewer {
        font-size: 11px;
      }
      div.imgViewer .fileName {
        overflow-x: hidden;
      }

      span.pagination {
        margin:8px;
      }
      button.button-pagination {
        min-width:70px;
        text-align: center;
      }

    </style>


<p class=" p-5 "><span id="logviewer-release" class="mx-5"></span> <a href="https://github.com/toutjavascript/Fooocus-Log-Viewer/" target="_blank" class="underline text-slate-200 hover:text-slate-50 dark:hover:text-slate-300">Bug report/ideas/discussions on <svg viewBox="0 0 16 16" class="w-5 h-5 inline" fill="currentColor" aria-hidden="true"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path></svg> github.com/toutjavascript/Fooocus-Log-Viewer</a></p>

<div class="m-2 p-2 mx-5 alert alert alert-light"><u><b><a href="https://github.com/toutjavascript/FoooXus-Fooocus-Extender/" target="_blank" class="">Manage your Styles, Models and Loras with my new FoooXus, Fooocus Extender tool <br><svg viewBox="0 0 16 16" class="w-5 h-5 inline" fill="currentColor" aria-hidden="true"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path></svg> github.com/toutjavascript/FoooXus-Fooocus-Extender</a></u></b></div>
 
<br><br><br><br>

</body>
</html>